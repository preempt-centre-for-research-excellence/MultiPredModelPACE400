---
title: "PACE_400_multimodal"
author: "Simon Hartmann"
date: "07/12/2021"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
always_allow_html: true
bibliography: PACE400.bib
csl: biological-psychiatry.csl
editor_options:
  chunk_output_type: inline
---

# Load packages

```{r, include=FALSE}
# Load packages -----------------
library(readxl)
library(tidyverse)
library(zoo)
library(kableExtra)
library(reshape2)
library(ggpubr)
library(caret)
library(rms)

library(glmnet)
library(boot)
library(cowplot)
```

## Define functions to calculate correlations and PCA table

```{r}
# Define functions ----------------
pca.table <- function(table.tmp, ind, a, b) {
  tmp.a <- summary(a)
  tmp.b <- summary(b)
  table.tmp[1:20,ind] <- c(tmp.a$importance['Proportion of Variance',c(1:10)], tmp.b$importance['Proportion of Variance',c(1:10)])
  return(table.tmp)
}
```

## Load data
```{r, , echo=FALSE}
#### LOAD DATA #####
# Load clinical measures
PACE_bl <- read_excel("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\Pace400_bl_data_to_Scott_Clark.xlsx")

# Load follow-up data
PACE_fup <- read_excel("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\Pace400_fup_data_to_Scott_Clark.xlsx")
# Load MRI Quality Control data
PACE_MRIQC <- read_excel("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\MRI_QC.xlsx")
# Load look-up table MRI ID and PACE 400 ID
caseid_MRI <- read_excel("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\caseid_to_BaselineMRI.xlsx")

# Load MRI thickness data
PACE_MRIthick <- read.delim("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\PACE400_MRIthickness_full_18_01_2022.csv",header = TRUE, sep = ",")
# Load MRI curvature data
PACE_MRIcurve <- read.delim("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\PACE400_MRImeancurve_full_18_01_2022.csv",header = TRUE, sep = ",")
# Load MRI surface data
PACE_MRIsurf <- read.delim("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\PACE400_MRIarea_full_18_01_2022.csv",header = TRUE, sep = ",")
#Load MRI volume data
PACE_MRIvol <- read.delim("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\PACE400_MRIvolume_full_18_01_2022.csv",header = TRUE, sep = ",")

# Load neurocognition data
PACE_Cog <- read_excel("U:\\PostDoc\\Research\\PRE-EMPT CRE\\Micah PACE analysis\\PACE400_NeuroCog_9_2_12.xlsx")

# Load brain age values
load("U:\\PostDoc\\repositories\\cox_psychosis\\PACE400_corrected_brainage.RData")
PACE_brainage <- brain_age_corrected_df


#### MERGE TABLES ####

# Remove follow-up gaf and qlst from follow-up data (not needed in analysis, avoids two gaf and qlst columns after merger with baseline table)
PACE_fup <- PACE_fup[,!(names(PACE_fup) %in% c('gaf', 'qlst'))] 

# Merge baseline with follow-up according to PACE 400 id
PACE_clinical <- list(PACE_bl, PACE_fup) %>% reduce(inner_join, by="caseid")


#### PREPARE CLINICAL DATA ####

# Remove subjects with not gaf or timepace information
PACE_clinical <- subset(PACE_clinical, !is.na(timepace))
PACE_clinical <- subset(PACE_clinical, !is.na(gaf))
PACE_clinical <- subset(PACE_clinical, !is.na(tc))
PACE_clinical <- subset(PACE_clinical, !is.na(cd))


# Calculate days until transition
PACE_clinical$transdays <- as.Date(as.character(PACE_clinical$enddate), format = "%Y-%m-%d") - as.Date(as.character(PACE_clinical$startdate), format = "%Y-%m-%d")

PACE_clinical$transmonths <- (as.yearmon(as.character(PACE_clinical$enddate), format = "%Y-%m-%d") - as.yearmon(as.character(PACE_clinical$startdate), format = "%Y-%m-%d"))*12

#### PREPARE NEUROCOGNITION TABLE ####

# Select neurocognition variables (age adjusted scales for Ward's subtests Arithmetic and Digit Symbol Coding)
PACE_neurocog <- PACE_Cog[,c('caseid','Ax1CodingASS','Ax1ArithASS')]

# Remove rows from MRI tables with less than 50%
PACE_neurocog <- PACE_neurocog[which(rowMeans(!is.na(PACE_neurocog)) > 0.5), ]
# Set subjects with missing Digit Symbol Coding or Arithmetic scores to NA
PACE_neurocog[PACE_neurocog$Ax1CodingASS < 0 & !is.na(PACE_neurocog$Ax1CodingASS), 'Ax1CodingASS'] <- NA
PACE_neurocog[PACE_neurocog$Ax1ArithASS < 0 & !is.na(PACE_neurocog$Ax1ArithASS), 'Ax1ArithASS'] <- NA
# Remove subjects with NA values
PACE_neurocog <- subset(PACE_neurocog, !is.na(Ax1CodingASS))
PACE_neurocog <- subset(PACE_neurocog, !is.na(Ax1ArithASS))

# Merge neurocogntion data with clinical data according to PACE 400 ID
PACE_neurocog <- list(PACE_clinical, PACE_neurocog) %>% reduce(inner_join, by="caseid")

# Calculate UHR categories
PACE_neurocog$pre.cond <- PACE_neurocog$blips + 2*PACE_neurocog$atten + 4*PACE_neurocog$vulner

# Remove subject with no UHR category
PACE_neurocog <- subset(PACE_neurocog, !is.na(pre.cond))

# Code UHR category according to dominant condition (BLIPS -> Attenuated -> Family History)
PACE_neurocog[PACE_neurocog$pre.cond == 3 | PACE_neurocog$pre.cond == 5  | PACE_neurocog$pre.cond == 7, c('pre.cond')] <- 1
PACE_neurocog[PACE_neurocog$pre.cond == 6 , c('pre.cond')] <- 2
PACE_neurocog[PACE_neurocog$pre.cond == 4 , c('pre.cond')] <- 3

# Remove duplicated rows
PACE_neurocog <- PACE_neurocog[!duplicated(PACE_neurocog$caseid), ]

#### PREPARE NEUROIMAGING TABLE ####

## Merge caseid and MRI quality data according to MRI ID
mriQC <- merge(PACE_MRIQC,caseid_MRI, by.x = "BaselineMRI", by.y = "BaselineMRI")

# Remove rows from MRI tables with less than 99% data prior to merging
PACE_MRIthick <- PACE_MRIthick[which(rowMeans(!is.na(PACE_MRIthick)) > 0.99), ]
PACE_MRIcurve <- PACE_MRIcurve[which(rowMeans(!is.na(PACE_MRIcurve)) > 0.99), ]
PACE_MRIsurf <- PACE_MRIsurf[which(rowMeans(!is.na(PACE_MRIsurf)) > 0.99), ]
PACE_MRIvol <- PACE_MRIvol[which(rowMeans(!is.na(PACE_MRIvol)) > 0.99), ]

# Join all MRI tables according to PACE 400 id
PACE_MRI <- list(PACE_MRIthick, PACE_MRIcurve, PACE_MRIsurf, PACE_MRIvol) %>% reduce(inner_join, by=c("caseid","ID"))

# Merge clinical and all three MRI tables (Quality Control, MRI values, and brainage)
PACE_MRI <- merge(PACE_MRI, mriQC, by.x = "caseid", by.y = "caseid")
PACE_MRI <- merge(PACE_clinical, PACE_MRI, by.x = "caseid", by.y = "caseid")
PACE_MRI <- merge(PACE_MRI, PACE_brainage, by.x = "caseid", by.y = "caseid")

# Only select subjects with good MRI quality 
PACE_MRI <- subset(PACE_MRI, QC == 1)

# Calculate UHR categories
PACE_MRI$pre.cond <- PACE_MRI$blips + 2*PACE_MRI$atten + 4*PACE_MRI$vulner
# Remove subject with no UHR category
PACE_MRI <- subset(PACE_MRI, !is.na(pre.cond))
# Code UHR category according to dominant condition (BLIPS -> Attenuated -> Family History)
PACE_MRI[PACE_MRI$pre.cond == 3 | PACE_MRI$pre.cond == 5  | PACE_MRI$pre.cond == 7, c('pre.cond')] <- 1
PACE_MRI[PACE_MRI$pre.cond == 6 , c('pre.cond')] <- 2
PACE_MRI[PACE_MRI$pre.cond == 4 , c('pre.cond')] <- 3

# Remove duplicated rows
PACE_MRI <- PACE_MRI[!duplicated(PACE_MRI$caseid), ]

#### PREPARE TABLES FOR PCA ANALYSIS ####
PACE_MRIthick <- PACE_MRIthick[PACE_MRIthick$caseid %in% PACE_MRI$caseid,]
PACE_MRIcurve <- PACE_MRIcurve[PACE_MRIcurve$caseid %in% PACE_MRI$caseid,]
PACE_MRIsurf <- PACE_MRIsurf[PACE_MRIsurf$caseid %in% PACE_MRI$caseid,]
PACE_MRIvol <- PACE_MRIvol[PACE_MRIvol$caseid %in% PACE_MRI$caseid,]

```

## Principal component analysis

Each structural map contains 34 variables each linked to a region of the brain. To reduce the dimension of the feature space, we applied principal component analysis (PCA). 
```{r, echo=FALSE}

# Split each domain in left and right hemisphere
PACE_MRIthick.caseid <- PACE_MRIthick$caseid
PACE_MRIthick.lh <- PACE_MRIthick[,c(2:((ncol(PACE_MRIthick)/2)-1))]
PACE_MRIthick.rh <- PACE_MRIthick[,c(((ncol(PACE_MRIthick))/2+1):(ncol(PACE_MRIthick)-2))]

PACE_MRIcurve.caseid <- PACE_MRIcurve$caseid
PACE_MRIcurve.lh <- PACE_MRIcurve[,c(2:((ncol(PACE_MRIcurve)/2)))]
PACE_MRIcurve.rh <- PACE_MRIcurve[,c(((ncol(PACE_MRIcurve))/2+1):(ncol(PACE_MRIcurve)-1))]

PACE_MRIsurf.caseid <- PACE_MRIsurf$caseid
PACE_MRIsurf.lh <- PACE_MRIsurf[,c(2:((ncol(PACE_MRIsurf)/2)-1))]
PACE_MRIsurf.rh <- PACE_MRIsurf[,c(((ncol(PACE_MRIsurf))/2+1):(ncol(PACE_MRIsurf)-2))]

PACE_MRIvol.caseid <- PACE_MRIvol$caseid
PACE_MRIvol.lh <- PACE_MRIvol[,c(2:((ncol(PACE_MRIvol)/2)))]
PACE_MRIvol.rh <- PACE_MRIvol[,c(((ncol(PACE_MRIvol))/2+1):(ncol(PACE_MRIvol)-1))]

```

Calculate PCA values and select only the first component for each hemisphere

```{r, echo=FALSE}

#### Calculate PCA for each domain and hemisphere ####

# Thickness
PACE_MRIthick.pcalh <- prcomp(PACE_MRIthick.lh, center = TRUE,scale. = TRUE, rank.=10)
PACE_MRIthick.pcarh <- prcomp(PACE_MRIthick.rh, center = TRUE,scale. = TRUE, rank.=10)
# Select the first thickness PCA for each hemisphere
MRI.thick <- as.data.frame(cbind(PACE_MRIthick.caseid, PACE_MRIthick.pcalh$x[,'PC1'], PACE_MRIthick.pcarh$x[,'PC1']))
# Rename selected PCAs
colnames(MRI.thick) <- c('caseid', 'thickness_lh', 'thickness_rh')


# Volume
PACE_MRIvol.pcalh <- prcomp(PACE_MRIvol.lh, center = TRUE,scale. = TRUE, rank.=10)
PACE_MRIvol.pcarh <- prcomp(PACE_MRIvol.rh, center = TRUE,scale. = TRUE, rank.=10)
# Select the first volume PCA for each hemisphere
MRI.vol <- as.data.frame(cbind(PACE_MRIvol.caseid, PACE_MRIvol.pcalh$x[,'PC1'], PACE_MRIvol.pcarh$x[,'PC1']))
# Rename selected PCAs
colnames(MRI.vol) <- c('caseid', 'volume_lh', 'volume_rh')


# Surface area
PACE_MRIsurf.pcalh <- prcomp(PACE_MRIsurf.lh, center = TRUE,scale. = TRUE, rank.=10)
PACE_MRIsurf.pcarh <- prcomp(PACE_MRIsurf.rh, center = TRUE,scale. = TRUE, rank.=10)
# Select the first surface area PCA for each hemisphere
MRI.surf <- as.data.frame(cbind(PACE_MRIsurf.caseid, PACE_MRIsurf.pcalh$x[,'PC1'], PACE_MRIsurf.pcarh$x[,'PC1']))
# Rename selected PCAs
colnames(MRI.surf) <- c('caseid', 'surface_lh', 'surface_rh')


# Curvature
PACE_MRIcurve.pcalh <- prcomp(PACE_MRIcurve.lh, center = TRUE,scale. = TRUE, rank.=10)
PACE_MRIcurve.pcarh <- prcomp(PACE_MRIcurve.rh, center = TRUE,scale. = TRUE, rank.=10)
# Select the first curvature PCA for each hemisphere
MRI.curve <- as.data.frame(cbind(PACE_MRIcurve.caseid, PACE_MRIcurve.pcalh$x[,'PC1'], PACE_MRIcurve.pcarh$x[,'PC1']))
# Rename selected PCAs
colnames(MRI.curve) <- c('caseid', 'curvature_lh', 'curvature_rh')

# Merge all selected MRI principal components
MRI.all <- merge(MRI.thick, MRI.vol, by.x = "caseid", by.y = "caseid")
MRI.all <- merge(MRI.all, MRI.curve, by.x = "caseid", by.y = "caseid")
MRI.all <- merge(MRI.all, MRI.surf, by.x = "caseid", by.y = "caseid")

# Merge MRI commponents with PACE data
PACE_MRI <- merge(PACE_MRI, MRI.all, by.x = "caseid", by.y = "caseid")
```

Create PCA table

```{r, echo=FALSE}
pc <- data.frame(Thickness=double(),
                 Volume=double(), 
                 Surface=double(), 
                 Curve=double()) 

pc <- pca.table(pc, 1, PACE_MRIthick.pcalh, PACE_MRIthick.pcarh)
pc <- pca.table(pc, 4, PACE_MRIcurve.pcalh, PACE_MRIcurve.pcarh)
pc <- pca.table(pc, 2, PACE_MRIvol.pcalh, PACE_MRIvol.pcarh)
pc <- pca.table(pc, 3, PACE_MRIsurf.pcalh, PACE_MRIsurf.pcarh)
pc <- round(pc, 2)
row.names(pc) <- c(paste('PC', c(1:10), 'lh', sep=''), paste('PC', c(1:10), 'rh', sep=''))

```

Show PCA table

```{r, echo=FALSE,  fig.height = 8, fig.width = 8, fig.align = "center"}
pc %>%
  kbl(caption = "Table 1: Proportion of variance [%] included in first 10 principal components of each hemisphere and structural map") %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  pack_rows("Left hemisphere", 1, 10) %>%
  pack_rows("Right hemisphere", 11, 20)
```

## Visualize PCA results

```{r, echo=FALSE}

pc_left <- pc[1:10,]*100
pc_left$x <- 1:10
pc_left_plot <- melt(pc_left, id.vars = "x")
pc_right <- pc[11:20,]*100
pc_right$x <- 1:10
pc_right_plot <- melt(pc_right, id.vars = "x")


pca_left_plot <- ggplot(pc_left_plot, aes(x = x, y = value, group = variable)) + 
       geom_line(aes(color = variable), size = 1.1) +
       geom_point(aes(color = variable), size = 3) +
       scale_x_continuous(name ="First ten principal components", breaks = c(1:10),
                    limits=c(1,10)) +
       scale_y_continuous(name="% of variance explained", breaks = c(0,25,50,75), limits=c(0, 75)) +
       theme_bw() +
       scale_color_brewer(palette="Set1") +
       ggtitle('Left hemisphere') + 
       labs(color = 'Cortical measure') +
       theme(plot.title = element_text(size = 18, hjust = 0.5),
             axis.title.x = element_text(size = 16),
             axis.title.y = element_text(size = 16),
             legend.text = element_text(size = 14),
             legend.title = element_text(size = 16),
             axis.text.x = element_text(size = 14),
             axis.text.y = element_text(size = 14)) +
       theme(legend.position="bottom")

pca_right_plot <- ggplot(pc_right_plot, aes(x = x, y = value, group = variable)) + 
       geom_line(aes(color = variable), size = 1.1) +
       geom_point(aes(color = variable), size = 3) +
       scale_x_continuous(name ="First ten principal components", breaks = c(1:10),
                    limits=c(1,10)) +
       scale_y_continuous(name="% of variance explained", breaks = c(0,25,50,75), limits=c(0, 75)) +
       theme_bw() +
       scale_color_brewer(palette="Set1") +
       ggtitle('Right hemisphere') + 
       labs(color = 'Cortical measure') +
       theme(plot.title = element_text(size = 18, hjust = 0.5),
             axis.title.x = element_text(size = 16),
             axis.title.y = element_text(size = 16),
             legend.text = element_text(size = 14),
             legend.title = element_text(size = 16),
             axis.text.x = element_text(size = 14),
             axis.text.y = element_text(size = 14)) +
       theme(legend.position="bottom")

ggarrange(pca_left_plot, pca_right_plot, ncol = 2, common.legend = TRUE, legend = "bottom")


# Thickness loading
load_thick_lh <- PACE_MRIthick.pcalh$rotation[,1]
thick_lh_best <- as.data.frame(abs(load_thick_lh[names(sort(abs(load_thick_lh), decreasing = TRUE)[1:10])]))
thick_lh_best$area <- rownames(thick_lh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(thick_lh_best) <- c('Loading', 'Area')
thick_lh_best$Area <- factor(thick_lh_best$Area, levels = thick_lh_best$Area)

load_thick_rh <- PACE_MRIthick.pcarh$rotation[,1]
thick_rh_best <- as.data.frame(abs(load_thick_rh[names(sort(abs(load_thick_rh), decreasing = TRUE)[1:10])]))
thick_rh_best$area <- rownames(thick_rh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(thick_rh_best) <- c('Loading', 'Area')
thick_rh_best$Area <- factor(thick_rh_best$Area, levels = thick_rh_best$Area)

left_loading <- ggplot(thick_lh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Left hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

right_loading <- ggplot(thick_rh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Right hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

thick.loading <- ggarrange(left_loading, right_loading, ncol = 2 )

thick.loading <- annotate_figure(thick.loading, top = text_grob("Thickness", 
               face = "bold", size = 20))
# Area loading
load_surf_lh <- PACE_MRIsurf.pcalh$rotation[,1]
surf_lh_best <- as.data.frame(abs(load_surf_lh[names(sort(abs(load_surf_lh), decreasing = TRUE)[1:10])]))
surf_lh_best$area <- rownames(surf_lh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(surf_lh_best) <- c('Loading', 'Area')
surf_lh_best$Area <- factor(surf_lh_best$Area, levels = surf_lh_best$Area)

load_surf_rh <- PACE_MRIsurf.pcarh$rotation[,1]
surf_rh_best <- as.data.frame(abs(load_surf_rh[names(sort(abs(load_surf_rh), decreasing = TRUE)[1:10])]))
surf_rh_best$area <- rownames(surf_rh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(surf_rh_best) <- c('Loading', 'Area')
surf_rh_best$Area <- factor(surf_rh_best$Area, levels = surf_rh_best$Area)

left_loading <- ggplot(surf_lh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Left hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

right_loading <- ggplot(surf_rh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Right hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

surf.loading <- ggarrange(left_loading, right_loading, ncol = 2 )

surf.loading <- annotate_figure(surf.loading, top = text_grob("Area", 
               face = "bold", size = 20))

# Volume loading
load_vol_lh <- PACE_MRIvol.pcalh$rotation[,1]
vol_lh_best <- as.data.frame(abs(load_vol_lh[names(sort(abs(load_vol_lh), decreasing = TRUE)[1:10])]))
vol_lh_best$area <- rownames(vol_lh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(vol_lh_best) <- c('Loading', 'Area')
vol_lh_best$Area <- factor(vol_lh_best$Area, levels = vol_lh_best$Area)

load_vol_rh <- PACE_MRIvol.pcarh$rotation[,1]
vol_rh_best <- as.data.frame(abs(load_vol_rh[names(sort(abs(load_vol_rh), decreasing = TRUE)[1:10])]))
vol_rh_best$area <- rownames(vol_rh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(vol_rh_best) <- c('Loading', 'Area')
vol_rh_best$Area <- factor(vol_rh_best$Area, levels = vol_rh_best$Area)

left_loading <- ggplot(vol_lh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Left hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

right_loading <- ggplot(vol_rh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Right hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

vol.loading <- ggarrange(left_loading, right_loading, ncol = 2 )

vol.loading <- annotate_figure(vol.loading, top = text_grob("Volume", 
               face = "bold", size = 20))

# Curve loading
load_curve_lh <- PACE_MRIcurve.pcalh$rotation[,1]
curve_lh_best <- as.data.frame(abs(load_curve_lh[names(sort(abs(load_curve_lh), decreasing = TRUE)[1:10])]))
curve_lh_best$area <- rownames(curve_lh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(curve_lh_best) <- c('Loading', 'Area')
curve_lh_best$Area <- factor(curve_lh_best$Area, levels = curve_lh_best$Area)

load_curve_rh <- PACE_MRIcurve.pcarh$rotation[,1]
curve_rh_best <- as.data.frame(abs(load_curve_rh[names(sort(abs(load_curve_rh), decreasing = TRUE)[1:10])]))
curve_rh_best$area <- rownames(curve_rh_best) %>%   strsplit( "_" ) %>%   sapply( "[", 2 )
colnames(curve_rh_best) <- c('Loading', 'Area')
curve_rh_best$Area <- factor(curve_rh_best$Area, levels = curve_rh_best$Area)

left_loading <- ggplot(curve_lh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Left hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

right_loading <- ggplot(curve_rh_best, aes(x=Loading, y=Area))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal() +
  scale_y_discrete(name ="Cortical segments", limits=rev, labels = ) +
  scale_x_continuous(name="Factor loading onto PC1", breaks = c(0, 0.1, 0.2, 0.3), limits=c(0,0.3)) +
  ggtitle('Right hemisphere') +
  theme(plot.title = element_text(size = 18, hjust = 0.5),
     axis.title.x = element_text(size = 16),
     axis.title.y = element_text(size = 16),
     legend.text = element_text(size = 14),
     legend.title = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14)) 

curve.loading <- ggarrange(left_loading, right_loading, ncol = 2 )

curve.loading <- annotate_figure(curve.loading, top = text_grob("Mean curvature", 
               face = "bold", size = 20))

ggarrange(thick.loading, vol.loading, curve.loading, surf.loading, nrow = 4)

```

## Cox regression analysis


```{r, include=FALSE}

# Calculate time to event and event status
dtime <- PACE_MRI$transmonths
event <- PACE_MRI$transtat

# Create empty data frames for regression results table
cox.table <- data.frame(hr1=double(),
                  p1=double(),
                  hr2=double(),
                 p2=double(),
                 hr3=double(),
                 p3=double(),
                 hr4=double(),
                 p4=double(),
                 hr5=double(),
                 p5=double(),
                 hr6=double(),
                 p6=double(),
                 LR_chisq=double(),
                 p = double(),
                 Fraction=double(),
                 cIndex=double()) 

# Create empty data frames for overfitting results table
overfit.table <- data.frame(delta_Dxy=double(),
                 delta_R2=double(), 
                 delta_slope=double())

# Preparation for imputation
w <- transcan(~ timepace + gaf + sanst + qlst + bprst + pa + cd + tc + atten + vulner + ttmt + pre.cond , imputed=TRUE, data = PACE_MRI, pl=FALSE, pr = FALSE)

# create variables out of columns
attach(PACE_MRI)

# Imputation
time.to.pace <- log(impute(w, timepace, data = PACE_MRI))
gaf <- impute(w, gaf, data = PACE_MRI)
sans <- impute(w, sanst, data = PACE_MRI)
qls <- impute(w, qlst, data = PACE_MRI)
bprs <- impute(w, bprst, data = PACE_MRI)
caarms.tc <- impute(w, tc, data = PACE_MRI)
caarms.cd <- impute(w, cd, data = PACE_MRI)
caarms.pa <- impute(w, pa, data = PACE_MRI)
atten <- impute(w, atten, data = PACE_MRI)
vulner <- impute(w, vulner, data = PACE_MRI)
ttmt <- impute(w, ttmt, data = PACE_MRI)
pre.cond <- impute(w, pre.cond, data = PACE_MRI)

pre.cond <- relevel(factor(pre.cond),ref='3')

# Preperation for cox model fit
dd <- datadist(time.to.pace, gaf, caarms.cd, caarms.tc, caarms.pa, ttmt, pre.cond)
options(datadist='dd')

# Define Surv model
S <- Surv(dtime, event)

set.seed(12)
```

Cox model using clinical variables

```{r, echo=FALSE}

# Compute clinical model
bl <- cph(S ~ time.to.pace + gaf + pre.cond, x=TRUE, y=TRUE, surv = TRUE, time.inc = 10*12)
# Get bootstrapped model
bl.conf <- bootcov(bl, B=1000, pr=TRUE)
# Extract regression parameters for each predictor
bl.an <- anova(bl.conf)
# Store regression summary
bl.summ <- summary(bl.conf, pre.cond = 3)
# Internal validation using bootstrapping
bl.val <- validate(bl, method="boot", B=1000, bw=FALSE)
# Store overfitting values
overfit.table[1,] <- c(bl.val['Dxy', 'optimism'], bl.val['R2','optimism'], bl.val['Slope','optimism'])
# Assign likelihood ratio test
LR.orig <- bl$stats['Model L.R.']
# Store regression results
cox.table[1,] <- c(bl.summ[2,4], bl.an[1,3], bl.summ[4,4], bl.an[2,3], bl.summ[6,4], bl.an[3,3], bl.summ[8,4], bl.an[3,3], 0, 0, 0, 0, LR.orig, 0, 1, bl.val['Dxy', 'index.corrected']/2 + 0.5)


```

Cox model using clinical plus CAARMS variables

```{r, echo=FALSE}

bl.caarms <- cph(S ~ time.to.pace + gaf + pre.cond + caarms.tc + caarms.cd, x=TRUE, y=TRUE, surv = TRUE, time.inc = 10*12)

bl.caarms.conf <- bootcov(bl.caarms, B=1000, pr=TRUE)

bl.caarms.an <- anova(bl.caarms.conf)

bl.caarms.summ <- summary(bl.caarms.conf, pre.cond = 3)

bl.caarms.val <- validate(bl.caarms.conf, method="boot", B=1000, bw=FALSE)

bl.caarms.p <- lrtest(bl.conf, bl.caarms)

cox.table[2,] <- c(bl.caarms.summ[2,4], bl.caarms.an[1,3], bl.caarms.summ[4,4], bl.caarms.an[2,3], bl.caarms.summ[10,4], bl.caarms.an[3,3],bl.caarms.summ[12,4], bl.caarms.an[3,3], bl.caarms.summ[6,4], bl.caarms.an[4,3], bl.caarms.summ[8,4], bl.caarms.an[5,3], bl.caarms$stats['Model L.R.'], bl.caarms.p$stats['P'], 1-(LR.orig/bl.caarms$stats['Model L.R.']), bl.caarms.val['Dxy', 'index.corrected']/2 + 0.5)

overfit.table[2,] <- c(bl.caarms.val['Dxy', 'optimism'], bl.caarms.val['R2','optimism'], bl.caarms.val['Slope','optimism'])

```

Cox model using clinical variables and MRI surface

```{r, echo=FALSE}

pc1.surf <- PACE_MRI$surface_lh
pc2.surf <- PACE_MRI$surface_rh

dd <- datadist(time.to.pace, gaf, pc1.surf,pc2.surf, pre.cond)
options(datadist='dd')
units(dtime) <- 'Month'

bl.surf <- cph(S ~ time.to.pace + gaf + pre.cond + pc1.surf + pc2.surf,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)

bl.surf.conf <- bootcov(bl.surf, B=1000, pr=TRUE)

bl.surf.an <- anova(bl.surf.conf)

bl.surf.summ <- summary(bl.surf.conf, pre.cond = 3)

bl.surf.p <- lrtest(bl.conf, bl.surf.conf)

bl.surf.val <- validate(bl.surf, method="boot", B=1000, bw=FALSE)

cox.table[3,] <- c(bl.surf.summ[2,4], bl.surf.an[1,3], bl.surf.summ[4,4], bl.surf.an[2,3], bl.surf.summ[10,4], bl.surf.an[3,3], bl.surf.summ[12,4], bl.surf.an[3,3], bl.surf.summ[6,4], bl.surf.an[4,3], bl.surf.summ[8,4], bl.surf.an[5,3], bl.surf$stats['Model L.R.'], bl.surf.p$stats['P'], 1-(LR.orig/bl.surf$stats['Model L.R.']), bl.surf.val['Dxy', 'index.corrected']/2 + 0.5)

overfit.table[3,] <- c(bl.surf.val['Dxy', 'optimism'], bl.surf.val['R2','optimism'], bl.surf.val['Slope','optimism'])

```

Cox model using clinical variables and MRI mean curvature

```{r, echo=FALSE}

pc1.curve <- PACE_MRI$curvature_lh
pc2.curve <- PACE_MRI$curvature_rh

dd <- datadist(time.to.pace, gaf, pc1.curve,pc2.curve, pre.cond)
options(datadist='dd')
units(dtime) <- 'Month'

bl.curve <- cph(S ~ time.to.pace + gaf + pre.cond + pc1.curve + pc2.curve,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)

bl.curve.conf <- bootcov(bl.curve, B=1000, pr=TRUE)

bl.curve.an <- anova(bl.curve.conf)

bl.curve.summ <- summary(bl.curve.conf, pre.cond = 3)

bl.curve.p <- lrtest(bl.conf, bl.curve.conf)

bl.curve.val <- validate(bl.curve, method="boot", B=1000, bw=FALSE)

cox.table[4,] <- c(bl.curve.summ[2,4], bl.curve.an[1,3], bl.curve.summ[4,4], bl.curve.an[2,3], bl.curve.summ[10,4], bl.curve.an[3,3], bl.curve.summ[12,4], bl.curve.an[3,3], bl.curve.summ[6,4], bl.curve.an[4,3], bl.curve.summ[8,4], bl.curve.an[5,3], bl.curve$stats['Model L.R.'], bl.curve.p$stats['P'], 1-(LR.orig/bl.curve$stats['Model L.R.']), bl.curve.val['Dxy', 'index.corrected']/2 + 0.5)

overfit.table[4,] <- c(bl.curve.val['Dxy', 'optimism'], bl.curve.val['R2','optimism'], bl.curve.val['Slope','optimism'])

```

Cox model using clinical variables and MRI volume

```{r, echo=FALSE}


pc1.vol <- PACE_MRI$volume_lh
pc2.vol <- PACE_MRI$volume_rh
dd <- datadist(time.to.pace, gaf, pc1.vol,pc2.vol, pre.cond)
options(datadist='dd')
units(dtime) <- 'Month'

bl.vol <- cph(S ~ time.to.pace + gaf + pre.cond + pc1.vol + pc2.vol,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)

bl.vol.conf <- bootcov(bl.vol, B=1000, pr=TRUE)

bl.vol.an <- anova(bl.vol.conf)

bl.vol.summ <- summary(bl.vol.conf, pre.cond = 3)

bl.vol.p <- lrtest(bl.conf, bl.vol.conf)

bl.vol.val <- validate(bl.vol, method="boot", B=1000, bw=FALSE)

cox.table[5,] <- c(bl.vol.summ[2,4], bl.vol.an[1,3], bl.vol.summ[4,4], bl.vol.an[2,3], bl.vol.summ[10,4], bl.vol.an[3,3], bl.vol.summ[12,4], bl.vol.an[3,3], bl.vol.summ[6,4], bl.vol.an[4,3], bl.vol.summ[8,4], bl.vol.an[5,3], bl.vol$stats['Model L.R.'], bl.vol.p$stats['P'], 1-(LR.orig/bl.vol$stats['Model L.R.']), bl.vol.val['Dxy', 'index.corrected']/2 + 0.5)

overfit.table[5,] <- c(bl.vol.val['Dxy', 'optimism'], bl.vol.val['R2','optimism'], bl.vol.val['Slope','optimism'])

```

Cox model using clinical variables and MRI thickness

```{r, echo=FALSE}

pc1.thick <- PACE_MRI$thickness_lh
pc2.thick <- PACE_MRI$thickness_rh

dd <- datadist(time.to.pace, gaf, pc1.thick,pc2.thick, pre.cond)
options(datadist='dd')
units(dtime) <- 'Month'

bl.thick <- cph(S ~ time.to.pace + gaf + pre.cond + pc1.thick + pc2.thick,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)

bl.thick.conf <- bootcov(bl.thick, B=1000, pr=TRUE)

bl.thick.an <- anova(bl.thick.conf)

bl.thick.summ <- summary(bl.thick.conf, pre.cond = 3)

bl.thick.p <- lrtest(bl.conf, bl.thick.conf)

bl.thick.val <- validate(bl.thick, method="boot", B=1000, bw=FALSE)

cox.table[6,] <- c(bl.thick.summ[2,4], bl.thick.an[1,3], bl.thick.summ[4,4], bl.thick.an[2,3], bl.thick.summ[10,4], bl.thick.an[3,3], bl.thick.summ[12,4], bl.thick.an[3,3], bl.thick.summ[6,4], bl.thick.an[4,3], bl.thick.summ[8,4], bl.thick.an[5,3], bl.thick$stats['Model L.R.'], bl.thick.p$stats['P'], 1-(LR.orig/bl.thick$stats['Model L.R.']), bl.thick.val['Dxy', 'index.corrected']/2 + 0.5)

overfit.table[6,] <- c(bl.thick.val['Dxy', 'optimism'], bl.thick.val['R2','optimism'], bl.thick.val['Slope','optimism'])

```

Cox model using clinical variables and brain age gap plus age

```{r, echo=FALSE}

brain_age <- PACE_MRI$corrected_gap
age <- PACE_MRI$age_bl

dd <- datadist(time.to.pace, gaf, brain_age, age, pre.cond)
options(datadist='dd')
units(dtime) <- 'Month'

bl.brainage <- cph(S ~ time.to.pace + gaf + pre.cond + brain_age + age,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)

bl.brainage.conf <- bootcov(bl.brainage, B=1000, pr=TRUE)

bl.brainage.an <- anova(bl.brainage.conf)

bl.brainage.summ <- summary(bl.brainage.conf, pre.cond = 3)

bl.brainage.p <- lrtest(bl.conf, bl.brainage.conf)

bl.brainage.val <- validate(bl.brainage, method="boot", B=1000, bw=FALSE)

cox.table[7,] <- c(bl.brainage.summ[2,4], bl.brainage.an[1,3], bl.brainage.summ[4,4], bl.brainage.an[2,3], bl.brainage.summ[10,4], bl.brainage.an[3,3], bl.brainage.summ[12,4], bl.brainage.an[3,3], bl.brainage.summ[6,4], bl.brainage.an[4,3], bl.brainage.summ[8,4], bl.brainage.an[5,3], bl.brainage$stats['Model L.R.'], bl.brainage.p$stats['P'], 1-(LR.orig/bl.brainage$stats['Model L.R.']), bl.brainage.val['Dxy', 'index.corrected']/2 + 0.5)

overfit.table[7,] <- c(bl.brainage.val['Dxy', 'optimism'], bl.brainage.val['R2','optimism'], bl.brainage.val['Slope','optimism'])

```


```{r, echo=FALSE}
cox.table <- round(cox.table, digits = 3)
overfit.table <- round(overfit.table, digits = 3)

row.names(overfit.table) <- c('Clinical','Clinical + Caarms','Clinical + MRI surface','Clinical + MRI curve', 'Clinical + MRI volume', 'Clinical + MRI thickness', 'Clinical + brain age')

row.names(cox.table) <- c('Clinical','Clinical + Caarms','Clinical + MRI surface','Clinical + MRI curve', 'Clinical + MRI volume', 'Clinical + MRI thickness', 'Clinical + brain age')

colnames(cox.table) <- c('HR timepace', 'P timepace', 'HR gaf','P gaf', 'HR UHR','P UHR', 'HR2 UHR', 'P UHR', 'HR 4', 'P 4', 'HR 5', 'P 5', 'LR', 'LR P', 'Fraction of new information', 'C index')

colnames(overfit.table) <- c('Optimism Dxy','Optimism R2','Optimism Slope')
```


Table lists the Cox model fit measures (Somer's D~xy, R)

```{r, echo=FALSE,  fig.height = 8, fig.width = 8, fig.align = "center"}
cox.table %>%
  kbl(caption = "Table 2: Comparison of model fit measures between nested models using Caarms, cognition, and structural imaging data") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
## Sensitivity and Specificity

```{r, echo=FALSE}

predicted.clinical <- survest(bl, data.frame(time.to.pace, gaf, pre.cond), times = c(24,60,120))
predicted.clinical.y <- predicted.clinical$surv
colnames(predicted.clinical.y) <- c('24','60','120')
predicted.imaging <- survest(bl.thick, data.frame(time.to.pace, gaf, pre.cond, pc1.thick, pc2.thick), times = c(24,60,120))
predicted.imaging.y <- predicted.imaging$surv
colnames(predicted.imaging.y) <- c('24','60','120')
pred.table.clin <- data.frame()
pred.table.imag <- data.frame()
j <- 1
for (mt in c(24,60,120)){
  gt <- transtat*(transmonths<mt)
  gt <- as.numeric(gt == 0)
  i <- 1
  for (th in c(0.1,0.2,0.3,0.4,0.5,0.6)){
    predicted.y <- as.numeric((1-predicted.clinical.y[,as.character(mt)]) < th)
    conf_matrix<-table(predicted.y,gt)
    pred.table.clin[i,j] <- precision(conf_matrix)
    pred.table.clin[i,j+1] <- specificity(conf_matrix)
    
    predicted.y <- as.numeric((1-predicted.imaging.y[,as.character(mt)]) < th)
    conf_matrix<-table(predicted.y,gt)
    pred.table.imag[i,j] <- precision(conf_matrix)
    pred.table.imag[i,j+1] <- specificity(conf_matrix)
    i <- i + 1
  }
  j <- j + 2
}


```
## Calibration

```{r, echo=FALSE,  fig.height = 7, fig.width = 7, fig.align = "center"}
set.seed(123)

dd <- datadist(time.to.pace, gaf, caarms.cd, caarms.tc, caarms.pa, pre.cond, pc1.thick, pc2.thick)
options(datadist='dd')

bl <- cph(S ~ time.to.pace + gaf + pre.cond, x=TRUE, y=TRUE, surv = TRUE, time.inc = 2*12)
bl.caarms <- cph(S ~ time.to.pace + gaf + pre.cond + caarms.tc + caarms.cd, x=TRUE, y=TRUE, surv = TRUE, time.inc = 2*12)
bl.thick <- cph(S ~ time.to.pace + gaf + pre.cond + pc1.thick + pc2.thick,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 2*12)

bl.cal <- calibrate(bl.thick, method = "boot", u= 2*12, m=10, B=1000, bw=FALSE)
bl.caarms.cal <- calibrate(bl.caarms, method = "boot", u= 2*12, m=10, B=1000, bw=FALSE)
bl.base.cal <- calibrate(bl, method = "boot", u= 2*12, m=10, B=1000, bw=FALSE)


pred <- as.data.frame(1 - bl.cal[,'pred'])
colnames(pred) <- c('x')

cal.correct <- as.data.frame(1 - bl.cal[,'calibrated.corrected'])
colnames(cal.correct) <- c('Value')
cal.correct$Type <- 'MRI'

cal.base.correct <- as.data.frame(1 - bl.base.cal[,'calibrated.corrected'])
colnames(cal.base.correct) <- c('Value')
cal.base.correct$Type <- 'clinical'

cal <- as.data.frame(bl.base.cal[,'calibrated'])
colnames(cal) <- c('Value')
cal$Type <- 'observed'

cal.caarms.correct <- as.data.frame(1 - bl.caarms.cal[,'calibrated.corrected'])
colnames(cal.caarms.correct) <- c('Value')
cal.caarms.correct$Type <- 'CAARMS'

cal_plot_data <- rbind(cbind(pred,cal.correct), cbind(pred, cal.base.correct), cbind(pred, cal.caarms.correct))


ggplot(cal_plot_data, aes(x = x, y = Value, group = Type)) + 
       geom_line(aes(color = Type), size = 1.1) +
       scale_x_continuous(name ="Predicted 2-year Probability of Psychosis", breaks = c(0.2,0.4,0.6,0.8), limits=c(0.15, 0.9)) +
       scale_y_continuous(name="Observed 2-year Probability of Psychosis", breaks = c(0.2,0.4,0.6,0.8), limits=c(0.15, 0.9)) +
       theme_bw() +
       labs(color = '') +
       geom_abline(aes(intercept = 0, slope = 1, color='black'))	+
        scale_color_manual(values = c("black" = "black", "clinical" = "#310374", "MRI" = "#d81a56", "CAARMS" = "#ffb42d"),
                           labels = c("ideal",  "base", "base + MRI", "base + CAARMS subscales"),
                                   guide = guide_legend(override.aes = list(pch = c(16, NA, NA, NA), linetype = c(1, 1, 1, 1)))) +
       theme(plot.title = element_text(size = 18, hjust = 0.5),
             axis.title.x = element_text(size = 16),
             axis.title.y = element_text(size = 16),
             legend.text = element_text(size = 14),
             legend.title = element_text(size = 16),
             axis.text.x = element_text(size = 14),
             axis.text.y = element_text(size = 14)) +
       theme(legend.position="bottom")

```

```{r, echo=FALSE,  fig.height = 7, fig.width = 7, fig.align = "center"}
set.seed(123)

dd <- datadist(time.to.pace, gaf, caarms.cd, caarms.tc, caarms.pa, pre.cond, pc1.thick, pc2.thick)
options(datadist='dd')

bl <- cph(S ~ time.to.pace + gaf + pre.cond, x=TRUE, y=TRUE, surv = TRUE, time.inc = 5*12)
bl.caarms <- cph(S ~ time.to.pace + gaf + pre.cond + caarms.tc + caarms.cd, x=TRUE, y=TRUE, surv = TRUE, time.inc = 5*12)
bl.thick <- cph(S ~ time.to.pace + gaf + pre.cond + pc1.thick + pc2.thick,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 5*12)

bl.cal <- calibrate(bl.thick, method = "boot", u= 5*12, m=10,B=1000, bw=FALSE)
bl.caarms.cal <- calibrate(bl.caarms, method = "boot", u= 5*12, m=10,B=1000, bw=FALSE)
bl.base.cal <- calibrate(bl, method = "boot", u= 5*12, m=10,B=1000, bw=FALSE)


pred <- as.data.frame(1 - bl.cal[,'pred'])
colnames(pred) <- c('x')

cal.correct <- as.data.frame(1 - bl.cal[,'calibrated.corrected'])
colnames(cal.correct) <- c('Value')
cal.correct$Type <- 'MRI'

cal.base.correct <- as.data.frame(1 - bl.base.cal[,'calibrated.corrected'])
colnames(cal.base.correct) <- c('Value')
cal.base.correct$Type <- 'clinical'

cal <- as.data.frame(bl.base.cal[,'calibrated'])
colnames(cal) <- c('Value')
cal$Type <- 'observed'

cal.caarms.correct <- as.data.frame(1 - bl.caarms.cal[,'calibrated.corrected'])
colnames(cal.caarms.correct) <- c('Value')
cal.caarms.correct$Type <- 'CAARMS'

cal_plot_data <- rbind(cbind(pred,cal.correct), cbind(pred, cal.base.correct), cbind(pred, cal.caarms.correct))


ggplot(cal_plot_data, aes(x = x, y = Value, group = Type)) + 
       geom_line(aes(color = Type), size = 1.1) +
       scale_x_continuous(name ="Predicted 5-year Probability of Psychosis", breaks = c(0.2,0.4,0.6,0.8), limits=c(0.15, 0.9)) +
       scale_y_continuous(name="Observed 5-year Probability of Psychosis", breaks = c(0.2,0.4,0.6,0.8), limits=c(0.15, 0.9)) +
       theme_bw() +
       labs(color = '') +
       geom_abline(aes(intercept = 0, slope = 1, color='black'))	+
        scale_color_manual(values = c("black" = "black", "clinical" = "#310374", "MRI" = "#d81a56", "CAARMS" = "#ffb42d"),
                           labels = c("ideal",  "base", "base + MRI", "base + CAARMS subscales"),
                                   guide = guide_legend(override.aes = list(pch = c(16, NA, NA, NA), linetype = c(1, 1, 1, 1)))) +
       theme(plot.title = element_text(size = 18, hjust = 0.5),
             axis.title.x = element_text(size = 16),
             axis.title.y = element_text(size = 16),
             legend.text = element_text(size = 14),
             legend.title = element_text(size = 16),
             axis.text.x = element_text(size = 14),
             axis.text.y = element_text(size = 14)) +
       theme(legend.position="bottom")

```


```{r, echo=FALSE,  fig.height = 7, fig.width = 7, fig.align = "center"}
set.seed(123)

dd <- datadist(time.to.pace, gaf, caarms.cd, caarms.tc, caarms.pa, pre.cond, pc1.thick, pc2.thick)
options(datadist='dd')

bl <- cph(S ~ time.to.pace + gaf + pre.cond, x=TRUE, y=TRUE, surv = TRUE, time.inc = 10*12)
bl.caarms <- cph(S ~ time.to.pace + gaf + pre.cond + caarms.tc + caarms.cd, x=TRUE, y=TRUE, surv = TRUE, time.inc = 10*12)
bl.thick <- cph(S ~ time.to.pace + gaf + pre.cond + pc1.thick + pc2.thick,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)

bl.cal <- calibrate(bl.thick, method = "boot", u= 10*12, m=10,B=1000, bw=FALSE)
bl.caarms.cal <- calibrate(bl.caarms, method = "boot", u= 10*12, m=10,B=1000, bw=FALSE)
bl.base.cal <- calibrate(bl, method = "boot", u= 10*12, m=10,B=1000, bw=FALSE)


pred <- as.data.frame(1 - bl.cal[,'pred'])
colnames(pred) <- c('x')

cal.correct <- as.data.frame(1 - bl.cal[,'calibrated.corrected'])
colnames(cal.correct) <- c('Value')
cal.correct$Type <- 'MRI'

cal.base.correct <- as.data.frame(1 - bl.base.cal[,'calibrated.corrected'])
colnames(cal.base.correct) <- c('Value')
cal.base.correct$Type <- 'clinical'

cal <- as.data.frame(bl.base.cal[,'calibrated'])
colnames(cal) <- c('Value')
cal$Type <- 'observed'

cal.caarms.correct <- as.data.frame(1 - bl.caarms.cal[,'calibrated.corrected'])
colnames(cal.caarms.correct) <- c('Value')
cal.caarms.correct$Type <- 'CAARMS'

cal_plot_data <- rbind(cbind(pred,cal.correct), cbind(pred, cal.base.correct), cbind(pred, cal.caarms.correct))


ggplot(cal_plot_data, aes(x = x, y = Value, group = Type)) + 
       geom_line(aes(color = Type), size = 1.1) +
       scale_x_continuous(name ="Predicted 10-year Probability of Psychosis", breaks = c(0.2,0.4,0.6,0.8), limits=c(0.15, 0.9)) +
       scale_y_continuous(name="Observed 10-year Probability of Psychosis", breaks = c(0.2,0.4,0.6,0.8), limits=c(0.15, 0.9)) +
       theme_bw() +
       labs(color = '') +
       geom_abline(aes(intercept = 0, slope = 1, color='black'))	+
        scale_color_manual(values = c("black" = "black", "clinical" = "#310374", "MRI" = "#d81a56", "CAARMS" = "#ffb42d"),
                           labels = c("ideal",  "base", "base + MRI", "base + CAARMS subscales"),
                                   guide = guide_legend(override.aes = list(pch = c(16, NA, NA, NA), linetype = c(1, 1, 1, 1)))) +
       theme(plot.title = element_text(size = 18, hjust = 0.5),
             axis.title.x = element_text(size = 16),
             axis.title.y = element_text(size = 16),
             legend.text = element_text(size = 14),
             legend.title = element_text(size = 16),
             axis.text.x = element_text(size = 14),
             axis.text.y = element_text(size = 14)) +
       theme(legend.position="bottom")

```


Cox Model using clinical variables and neurocognition variables

```{r, echo=FALSE}

# Create empty data frames for regression results table
cox.table <- data.frame(hr1=double(),
                  p1=double(),
                  hr2=double(),
                 p2=double(),
                 hr3=double(),
                 p3=double(),
                 hr4=double(),
                 p4=double(),
                 hr5=double(),
                 p5=double(),
                 hr6=double(),
                 p6=double(),
                 LR_chisq=double(),
                 p = double(),
                 Fraction=double(),
                 cIndex=double()) 

# Create empty data frames for overfitting results table
overfit.table <- data.frame(delta_Dxy=double(),
                 delta_R2=double(), 
                 delta_slope=double())

dtime <- PACE_neurocog$transmonths
event <- PACE_neurocog$transtat

rm(time.to.pace, gaf, ttmt, pre.cond, caarms.tc, caarms.cd)

# Preperation for imputation
w <- transcan(~ timepace + gaf +  ttmt + pre.cond + tc + cd + Ax1CodingASS + Ax1ArithASS, imputed=TRUE, data = PACE_neurocog, pl=FALSE, pr = FALSE)

# create variables out of columns
attach(PACE_neurocog)

# Imputation
time.to.pace <- log(impute(w, timepace, data = PACE_neurocog))
gaf <- impute(w, gaf, data = PACE_neurocog)
ttmt <- impute(w, ttmt, data = PACE_neurocog)
pre.cond <- impute(w, pre.cond, data = PACE_neurocog)
kauf.iq <- impute(w, Ax1CodingASS, data = PACE_neurocog)
wards.iq <- impute(w, Ax1ArithASS, data = PACE_neurocog)
caarms.tc <- impute(w, tc, data = PACE_MRI)
caarms.cd <- impute(w, cd, data = PACE_MRI)

pre.cond <- relevel(factor(pre.cond),ref=3)
# Preperation for cox model fit
dd <- datadist(time.to.pace, gaf, ttmt, pre.cond, kauf.iq, wards.iq, caarms.cd, caarms.tc)
options(datadist='dd')


# Define Surv model
S <- Surv(dtime, event)

bl <- cph(S ~ time.to.pace + gaf + pre.cond, x=TRUE, y=TRUE, surv = TRUE, time.inc = 10*12)

# Get bootstrapped model
bl.conf <- bootcov(bl, B=1000, pr=TRUE)

bl.an <- anova(bl.conf)

bl.summ <- summary(bl.conf, pre.cond = 3)

bl.val <- validate(bl, method="boot", B=1000, bw=FALSE)

LR.orig <- bl$stats['Model L.R.']

cox.table[1,] <- c(bl.summ[2,4], bl.an[1,3], bl.summ[4,4], bl.an[2,3], bl.summ[6,4], bl.an[3,3], bl.summ[8,4], bl.an[3,3], 0, 0, 0, 0, LR.orig, 0, 1, bl.val['Dxy', 'index.corrected']/2 + 0.5)


bl.caarms <- cph(S ~ time.to.pace + gaf + pre.cond + caarms.tc + caarms.cd, x=TRUE, y=TRUE, surv = TRUE, time.inc = 10*12)

# Get bootstrapped model
bl.caarms.conf <- bootcov(bl.caarms, B=1000, pr=TRUE)

bl.caarms.an <- anova(bl.caarms.conf)

bl.caarms.summ <- summary(bl.caarms.conf, pre.cond = 3)

bl.caarms.val <- validate(bl.caarms, method="boot", B=1000, bw=FALSE)

bl.caarms.p <- lrtest(bl.conf, bl.caarms.conf)

cox.table[2,] <- c(bl.caarms.summ[2,4], bl.caarms.an[1,3], bl.caarms.summ[4,4], bl.caarms.an[2,3], bl.caarms.summ[10,4], bl.caarms.an[3,3], bl.caarms.summ[12,4], bl.caarms.an[3,3], bl.caarms.summ[6,4], bl.caarms.an[4,3], bl.caarms.summ[8,4], bl.caarms.an[5,3], bl.caarms$stats['Model L.R.'], bl.caarms.p$stats['P'], 1-(LR.orig/bl.caarms$stats['Model L.R.']), bl.caarms.val['Dxy', 'index.corrected']/2 + 0.5)


bl.cog <- cph(S ~ time.to.pace + gaf + pre.cond + kauf.iq + wards.iq,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)

# Get bootstrapped model
bl.cog.conf <- bootcov(bl.cog, B=1000, pr=TRUE)

bl.cog.an <- anova(bl.cog.conf)

bl.cog.summ <- summary(bl.cog.conf, pre.cond = 3)

bl.cog.p <- lrtest(bl.conf, bl.cog.conf)

bl.cog.val <- validate(bl.cog, method="boot", B=1000, bw=FALSE)

cox.table[3,] <- c(bl.cog.summ[2,4], bl.cog.an[1,3], bl.cog.summ[4,4], bl.cog.an[2,3], bl.cog.summ[10,4], bl.cog.an[3,3], bl.cog.summ[12,4], bl.cog.an[3,3], bl.cog.summ[6,4], bl.cog.an[4,3], bl.cog.summ[8,4], bl.cog.an[5,3], bl.cog$stats['Model L.R.'], bl.cog.p$stats['P'], 1-(LR.orig/bl.cog$stats['Model L.R.']), bl.cog.val['Dxy', 'index.corrected']/2 + 0.5)

overfit.table[3,] <- c(bl.cog.val['Dxy', 'optimism'], bl.cog.val['R2','optimism'], bl.cog.val['Slope','optimism'])

```


```{r, echo=FALSE}
cox.table <- round(cox.table, digits = 3)
overfit.table <- round(overfit.table, digits = 3)

row.names(overfit.table) <- c('Clinical','Clinical + Caarms','Clinical + Neurocognition')

row.names(cox.table) <- c('Clinical','Clinical + Caarms','Clinical + Neurocognition')

colnames(cox.table) <- c('HR timepace', 'P timepace', 'HR gaf','P gaf', 'HR UHR','P UHR', 'HR2 UHR', 'P UHR', 'HR 4', 'P 4', 'HR 5', 'P 5', 'LR', 'LR P', 'Fraction of new information', 'C index')

colnames(overfit.table) <- c('Optimism Dxy','Optimism R2','Optimism Slope')
```


Table lists the Cox model fit measures (Somer's D~xy, R)

```{r, echo=FALSE,  fig.height = 8, fig.width = 8, fig.align = "center"}
cox.table %>%
  kbl(caption = "Table 2: Comparison of model fit measures between nested models using Caarms, cognition, and structural imaging data") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```


## LASSO regularization

```{r, echo=FALSE,  fig.height = 7, fig.width = 7, fig.align = "center"}


get_lambda <- function(fit, tol = .5) {
  error <- fit$cvm[fit$lambda == fit$lambda.min]
  sd <- fit$cvsd[fit$lambda == fit$lambda.min]
  tolerance <- error + tol*sd
  max(fit$lambda[fit$cvm < tolerance])
}

PACE_sub <- PACE_MRI[,c('transmonths','transtat','timepace','gaf','pre.cond','caseid')]
colnames(PACE_sub) <- c('time','status','timepace','gaf','pre.cond','caseid')

lasso_set <- merge(PACE_sub, PACE_MRIthick[,2:ncol(PACE_MRIthick)], by.x = 'caseid', by.y = 'caseid')

lasso_set <- lasso_set[which(rowMeans(!is.na(lasso_set)) > 0.99), ]

lasso_set <- subset(lasso_set, time > 0 )

y.lasso <- lasso_set[,c('time','status')]
x.lasso <- lasso_set[,!names(lasso_set) %in% c('time','status','caseid','lh_MeanThickness_thickness','rh_MeanThickness_thickness')]

x.lasso<-(x.lasso-lapply(x.lasso, mean, na.rm = TRUE))/lapply(x.lasso, sd, na.rm = TRUE)

x.train <- as.matrix(x.lasso)
y.train <- as.matrix(y.lasso)

#penalty.factor=c(0, 0, rep(1, ncol(x.train) - 2)),
set.seed(1234)
lasso.fit.cv <- cv.glmnet(x = x.train, y = y.train, type.measure = "deviance",
                     family = "cox", nfolds = 10, alpha = 1, standardize = TRUE)


lasso.coef <- function(data, indices) {
  d <- data[indices,]
  fit <- glmnet(x = d[,c(3:ncol(d))], y = d[,c(1,2)], 
                    alpha = 1, family = "cox", lambda = get_lambda(lasso.fit.cv, 0.25), standardize = TRUE)
  return(coef(fit)[,1])
}

boot.out <- boot(data = cbind(y.train, x.train), statistic = lasso.coef, R = 1000)

ggplot() +
  geom_histogram(bins = 100, aes(boot.out$t[,which.max(abs(boot.out$t0[-1])) + 1]),
                 fill = "darkgoldenrod2",
                 colour = "black",
                 lwd = 0.25) +
  xlab("Top variable bootstrapped coefficients") +
  theme_cowplot()

ci.vector <- function(index, boot.object, ci.type) {
  x <- boot.ci(boot.object, type = ci.type, index = index)
  return(x[4])
}

n <- length(boot.out$t0)
boot.ci.out <- sapply(1:n, ci.vector, boot.object = boot.out, ci.type = "basic")
x <- boot.out$t0[1:n]
y <- data.frame(t(matrix(unlist(boot.ci.out), ncol = n)))[4:5]
ci.df <- cbind(x, y)
names(ci.df) <- c("coef", "l.ci", "u.ci")

# drop intercept from plot using [-1] in vector ci.df$l.ci and ci.df$u.ci (i.e., the intercept is the top row)
lasso.vars.list <- colnames(x.lasso[,c(1:ncol(x.lasso))])
sig.vars.index <- which(ci.df$coef != 0)
#sig.vars.index <- which(ci.df$l.ci > 0 | ci.df$u.ci < 0)
sig.vars.list <- lasso.vars.list[sig.vars.index]
sig.vars.df <- ci.df[sig.vars.index,] ## add 1 to omit intercept row
sig.vars.df <- cbind(sig.vars.list, round(sig.vars.df,4))
kable(sig.vars.df[order(abs(sig.vars.df$coef), decreasing = T),])


# fit.lasso <- glmnet(x = x.train[,sig.vars.index], y = y.train, 
#                     alpha = 1, family = "cox", lambda = get_lambda(lasso.fit.cv, 1), standardize = TRUE)
# 
# new_sub <- PACE_MRI[,c('transmonths','transtat','log_timepace','gaf','caseid','thickness_lh','thickness_rh')]
# colnames(new_sub) <- c('time','status','log_timepace','gaf','caseid','thick_lh','thick_rh')
# 
# new_sub <- new_sub[which(rowMeans(!is.na(new_sub)) > 0.99), ]
# new_sub <- subset(new_sub, time > 0 )
# 
# x.train2 <- as.matrix(new_sub[,c(3,4,6,7)])
# y.train2 <- as.matrix(new_sub[,1:2])
# 
# fit.thick <- glmnet(x = x.train2, y = y.train2, family = "cox", standardize = TRUE, lambda = get_lambda(lasso.fit.cv, 1))
# 
# s1 <- survfit( Surv(y.lasso$time, y.lasso$status) ~ 1)
# s2 <- survfit(fit.lasso, x = x.train[,sig.vars.index], y = Surv(y.lasso$time, y.lasso$status))
# s3 <- survfit(fit.thick, x = x.train2, y = Surv(new_sub[,1], new_sub[,2]))
# 
# s1_plot <- as.data.frame(cbind(s1$time, s1$surv))
# s1_plot$class <- 0
# s2_plot <- as.data.frame(cbind(s2$time, s2$surv))
# s2_plot$class <- 1
# s3_plot <- as.data.frame(cbind(s3$time, s3$surv))
# s3_plot$class <- 2
# 
# s_all <- rbind(s1_plot, s2_plot, s3_plot)
# 
# plot(cal_int, xlim = c(0, 1), ylim = c(0,1))

# pc1.thick <- PACE_MRIthick$lh_lateralorbitofrontal_thickness
# pc2.thick <- PACE_MRIthick$lh_rostralmiddlefrontal_thickness
# 
# 
# dd <- datadist(time.to.pace, gaf, caarms.cd, caarms.tc, pre.cond, ttmt, pc1.thick,pc2.thick)
# options(datadist='dd')
# units(dtime) <- 'Month'
# 
# bl.thick <- cph(S ~ rcs(time.to.pace,4) + gaf + pc1.thick + pc2.thick,  x=TRUE, y=TRUE, surv=TRUE, time.inc = 10*12)
# 
# bl.thick.an <- anova(bl.thick)
# 
# bl.thick.summ <- summary(bl.thick)
# 
# bl.thick.p <- lrtest(bl, bl.thick)
# 
# bl.thick.val <- rms::validate(bl.thick, method="boot", B=200, bw=FALSE)
# 
# cox.table[7,] <- c(bl.thick.summ[2,4], bl.thick.an[1,3], 0, bl.thick.an[2,3], bl.thick.summ[4,4], bl.thick.an[3,3], bl.thick.summ[6,4], bl.thick.an[4,3], bl.thick.summ[8,4], bl.thick.an[5,3], bl.thick$stats['Model L.R.'], bl.thick.p$stats['P'], 1-(LR.orig/bl.thick$stats['Model L.R.']), bl.thick.val['Dxy', 'index.corrected']/2 + 0.5)
# 
# overfit.table[7,] <- c(bl.thick.val['Dxy', 'optimism'], bl.thick.val['R2','optimism'], bl.thick.val['Slope','optimism'])

```
